# Installation

## Dependencies

### Using conda
1) Download [miniconda installation script](https://conda.io/miniconda.html):

    GNU/Linux command:
    
    ```
    wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
    ```
    
    32-bit installation:
    
    ```
    wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86.sh
    ```

2) Follow installation [instructions](https://conda.io/docs/user-guide/install/index.html)

    GNU/Linux command:

    ```
    bash ./Miniconda3-latest-Linux-x86_64.sh -b -p /miniconda/installation/directory
    ```

    NOTE: to write in an existing directory, add option `-f`
    NOTE: miniconda must be added to PATH, either manually or through editing `~/.bashrc`, example commands:

    ```
    export PATH=/miniconda/install/directory/bin:$PATH
    source /miniconda/install/directory/bin/activate
    ```

    Windows command (fails in PowerShell):

    ```
    set PATH=%PATH%;C:\path\to\miniconda\;C:\path\to\miniconda\Scripts\
    ```

    NOTE: if conda is already installed (version 2 or 3), just create a dedicated environment:

    ```
    conda create --name moltenprot python=3
    conda activate moltenprot
    ```    `

3) Install the dependencies:

    ```
    conda install pandas scipy openpyxl xlrd matplotlib pyqt setuptools
    ```

NOTE: pyqt is only required to run the GUI

Optional: install joblib module to run some parts of the code in parallel

```
conda install joblib
```

### Using pip
1) download and install Python 3 with tk/tcl support, pip and add it to PATH
    [Windows](https://www.python.org/downloads/windows/)
    
    Mac:
    * if needed, install homebrew:

    ```
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
    # to disable analytics
    brew analytics off
    ```

    * install Python 3

    ```
    brew install python3
    ```

    NOTE: On recent GNU/Linux distros dependencies can be installed from the package manager (even without pip).

2) Install dependencies:
    `pip install pandas scipy openpyxl xlrd matplotlib pyqt5 setuptools`

    NOTE: on Mac with Homebrew use `pip3` instead
    
    NOTE: Mac M1 may have additional troubles due to the processor architecture. The following commands worked well in mid-2021:
    ```
    python3 -m pip install Cython
    python3 -m pip install --no-binary :all: --no-use-pep517 numpy
    python3 -m pip install pybind11
    brew install openblas gfortran
    export OPENBLAS=/opt/homebrew/opt/openblas/lib/
    pip3 install pythran
    pip3 install --no-binary :all: --no-use-pep517 scipy
    # PyQt5 needs to be installed via homebrew
    brew install pyqt@5
    ```

## MoltenProt
1) download the source code:

    `http://marlovitslab.org/lab/Download.html`

    NOTE: MoltenProt can be run straight away without installation from the folder where it was downloaded:

    ```
    python moltenprot --help
    python moltenprot --gui
    ```

2) build and install MoltenProt via `setup.py`

    ```
    python setup.py install
    ```

    keep track of installed files:

    ```
    python setup.py install --record installed_files.txt
    ```

    Upon installation the following commands will be available for CLI and GUI modes:

    ```
    moltenprot
    moltenprot_gui
    ```

    MoltenProt can be also started anywhere as a Python module:

    ```
    python -m moltenprot --gui
    ```

3) Create shortcuts (optional) for a terminal-less startup:

    * install [shortcutter](https://pypi.org/project/shortcutter/) via conda:

    ```
    conda install -c defaults -c conda-forge shortcutter
    ```

    * load the conda environment with MoltenProt and run:

    ```
    shortcutter moltenprot_gui --name MoltenProt
    ```

This will create a desktop and menu shortcuts for MoltenProt GUI (use options `--desktop` or `--menu` to create a specific one). The shortcuts will have a default icon. The MoltenProt icon is located in `moltenprot/ui/icons/app_icon.ico`.

Alternatively, use PyInstaller bundles (see below on how to build them).

### PyInstaller bundles on MacOS
MacOS may prohibit startup of "non-verified" programs. To fix this in command line:
```
# check if the file is in quarantine
xattr moltenprot_mac.app
# quarantined apps will have attribute `com.apple.quarantine`
# remove the attribute recursively
xattr -r -d com.apple.quarantine moltenprot_mac.app
```
[link](https://apple.stackexchange.com/questions/387000)

# Developer info
## Tracing warnings

`python -W error -m moltenprot`

## Code maintenance
Install black to standardize formatting, pyflakes for code linting and pyinstaller for packaging:

```
conda install black pyinstaller pyflakes
black __main__.py models.py core.py gui.py
python -m pyflakes __main__.py models.py core.py gui.py
```

If the GUI or help text in ODT format is edited, run `make_resources.sh`.

Clean up old stuff from conda:

```
conda clean -pt
```

## Packaging with PyInstaller
PyInstaller is available either via pip or in conda.

### GNU/Linux
```
conda install pyinstaller
pyinstaller -y -n moltenprot --hidden-import=scipy.special.cython_special --add-data "./moltenprot/VERSION:./moltenprot" --add-binary "../miniconda3/envs/moltenprot/lib/libiomp5.so:." --add-data "./moltenprot/resources/report.template:./moltenprot/resources/" --exclude-module joblib ./moltenprot/__main__.py
```

### Windows
```
pyinstaller moltenprot_win.spec
```
Original pyinstaller command to produce spec file:
```
pyinstaller -y -n moltenprot -w -i moltenprot\ui\icons\app_icon.ico --add-data .\moltenprot\VERSION;moltenprot --add-data .\COPYING;moltenprot --add-data .\moltenprot\doc\index.pdf;help --add-data .\moltenprot\resources\demo1.csv;demo_data\ --add-data .\moltenprot\resources\demo2.xlsx;demo_data\ --add-data .\moltenprot\resources\report.template;moltenprot\resources\ --exclude-module joblib --hidden-import scipy.special.cython_special moltenprot\__main__.py
```
pathex was removed from the spec file to make it portable.

### Mac OS
```
pyinstaller moltenprot_mac.spec
```
Original pyinstaller command to produce spec file:
```
pyinstaller -y -w -n moltenprot_mac  -i moltenprot/ui/icons/app_icon.ico --add-data moltenprot/VERSION:moltenprot --add-data COPYING:moltenprot --add-data moltenprot/doc/index.pdf:help --add-data moltenprot/resources/demo1.csv:demo_data --add-data moltenprot/resources/demo2.xlsx:demo_data --add-data moltenprot/resources/report.template:moltenprot/resources --exclude-module joblib --hidden-import scipy.special.cython_special moltenprot/__main__.py
```

### Notes:
* The output folder is quite large (~1 GB), presumably due to the presence of MKL library. This is inevitable, because scipy for Windows is only available with MKL
* joblib has to be excluded, because it wrongly re-imports modules when run from a bundle
* the path for libiomp5.so should point to the respective env installation (GNU/Linux specific issue)
* running as `python -OO -m PyInstaller` additionally strips assertions and docstrings in all files, which can save space, but is not compatible with numpy (python -O seems to work OK)
* When bundled from conda, Windows version does not load beyound the splashscreen and data analysis does not start - crashes without any message. Packaging works, when everything is installed with standard Python distribution and pip
* bundled -w mode does not print anything to the command line, however, the CLI itself works
* if getting `ModuleNotFoundError: No module named 'pkg_resources.py2_warn`, downgrade setuptools `pip3 install --upgrade 'setuptools<45.0.0'`


Copyright 2018-2021 Vadim Kotov

Copying and distribution of this file, with or without modification,
are permitted in any medium without royalty provided the copyright
notice and this notice are preserved.  This file is offered as-is,
without any warranty.
